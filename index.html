<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flight Animation Globe</title>
<style>
  body, html { margin:0; padding:0; overflow:hidden; background:#000; height:100%; }
  canvas { display:block; width:100vw; height:100vh; }
  .tooltip { position:absolute; color:white; font-family:Arial; font-size:16px; pointer-events:none; white-space:nowrap; }
</style>
</head>
<body>
<canvas id="globeCanvas"></canvas>
<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script src="https://unpkg.com/three-globe"></script>

<script>
const canvas = document.getElementById('globeCanvas');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 2000);
camera.position.set(0,0,400);

const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);

// === Luzes ===
scene.add(new THREE.AmbientLight(0xffffff,0.7));
const dirLight = new THREE.DirectionalLight(0xffffff,0.6);
dirLight.position.set(5,3,5);
scene.add(dirLight);

// === Labels ===
const cities = [
  { name:'BELÉM / BRAZIL', lat:-1.455, lng:-48.503 },
  { name:'ESWATINI', lat:-26.5225, lng:31.4659 },
  { name:'SOUTH AFRICA', lat:-30.5595, lng:22.9375 }
];
const labels = cities.map(c=>{
  const div=document.createElement('div');
  div.className='tooltip';
  div.innerText=c.name;
  document.body.appendChild(div);
  return {div, lat:c.lat, lng:c.lng};
});

// === Função utilitária ===
function latLngToVector3(lat,lng,radius){
  const phi=(90-lat)*(Math.PI/180);
  const theta=(lng+180)*(Math.PI/180);
  const x=-radius*Math.sin(phi)*Math.cos(theta);
  const y=radius*Math.cos(phi);
  const z=radius*Math.sin(phi)*Math.sin(theta);
  return new THREE.Vector3(x,y,z);
}

function updateLabels(){
  const vector=new THREE.Vector3();
  labels.forEach(l=>{
    vector.copy(latLngToVector3(l.lat,l.lng,Globe.globeRadius+2));
    vector.project(camera);
    const x=(vector.x*0.5+0.5)*window.innerWidth;
    const y=(-vector.y*0.5+0.5)*window.innerHeight;
    l.div.style.transform=`translate(-50%,-50%) translate(${x}px,${y}px)`;
    l.div.style.opacity=vector.z>1?0:1;
  });
}

// === Avião ===
const airplane=new THREE.Mesh(
  new THREE.ConeGeometry(1,4,8),
  new THREE.MeshBasicMaterial({color:'red'})
);
airplane.rotation.x=Math.PI/2;
scene.add(airplane);

// === Rotas ===
const flights=[
  { start:{lat:-1.455,lng:-48.503}, end:{lat:-26.5225,lng:31.4659} },
  { start:{lat:-26.5225,lng:31.4659}, end:{lat:-30.5595,lng:22.9375} }
];
let t=0, currentFlight=0;

function interpolate(start,end,t){
  return { lat:start.lat+(end.lat-start.lat)*t, lng:start.lng+(end.lng-start.lng)*t };
}

// === Criar o globo e adicionar à cena só depois do carregamento ===
const Globe = new ThreeGlobe()
  .globeImageUrl('https://raw.githubusercontent.com/roblabs/three-globe/master/example/img/earth-blue-marble.jpg')
  .bumpImageUrl('https://raw.githubusercontent.com/roblabs/three-globe/master/example/img/earth-topology.png')
  .arcsData([
    { startLat:-1.455,startLng:-48.503,endLat:-26.5225,endLng:31.4659,color:'red' },
    { startLat:-26.5225,startLng:31.4659,endLat:-30.5595,endLng:22.9375,color:'yellow' }
  ])
  .arcColor('color')
  .arcDashLength(0.4)
  .arcDashGap(4)
  .arcDashInitialGap(()=>Math.random()*5)
  .arcDashAnimateTime(4000)
  .arcStroke(1.5);

// Garantir que o globo só seja renderizado quando a textura carregar
new THREE.TextureLoader().load(
  'https://raw.githubusercontent.com/roblabs/three-globe/master/example/img/earth-blue-marble.jpg',
  function(texture){
    Globe.globeImageUrl(texture.image.src);
    scene.add(Globe);
  }
);

// === Atualizar avião + câmera ===
function updateAirplaneAndCamera(){
  t+=0.002;
  if(t>1){ t=0; currentFlight=(currentFlight+1)%flights.length; }
  const path=flights[currentFlight];
  const pos=interpolate(path.start,path.end,t);
  const vec=latLngToVector3(pos.lat,pos.lng,Globe.globeRadius+5);
  airplane.position.copy(vec);

  const nextPos=interpolate(path.start,path.end,Math.min(t+0.01,1));
  const nextVec=latLngToVector3(nextPos.lat,nextPos.lng,Globe.globeRadius+5);
  airplane.lookAt(nextVec);

  camera.position.lerp(vec.clone().multiplyScalar(2.8),0.02);
  camera.lookAt(vec);
}

// === Animate ===
function animate(){
  requestAnimationFrame(animate);
  if(Globe){ Globe.rotation.y+=0.0005; }
  updateLabels();
  updateAirplaneAndCamera();
  renderer.render(scene,camera);
}
animate();

// === Resize ===
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
